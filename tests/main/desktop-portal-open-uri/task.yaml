summary: the desktop portal allows confined apps to open URIs
description: |
    The xdg-desktop-portal "Open URI" interface provides a way for
    confined applications to open URIs using the host system's
    preferred browser.

# Only enable the test on systems we know portals to function on.
# Expand as needed.
systems:
  - ubuntu-18.04-*
  - ubuntu-18.10-*
  - ubuntu-19.04-*

prepare: |
    #shellcheck source=tests/lib/desktop-portal.sh
    . "$TESTSLIB"/desktop-portal.sh
    setup_portals

    # Configure fake web browser
    mkdir -p ~test/.local/share/applications
    cat << EOF > ~test/.local/share/applications/test-browser.desktop
    [Desktop Entry]
    Type=Application
    Name=Test Web Browser
    Exec=$(pwd)/web-browser.sh %u
    MimeType=x-scheme-handler/http;
    EOF
    mkdir -p ~test/.config
    cat << EOF > ~test/.config/mimeapps.list
    [Default Applications]
    x-scheme-handler/http=test-browser.desktop
    EOF
    rm -f /tmp/browser-history.txt

restore: |
    #shellcheck source=tests/lib/pkgdb.sh
    . "$TESTSLIB"/desktop-portal.sh
    teardown_portals

    rm -f ~test/.config/mimeapps.list
    rm -f ~test/.local/share/applications/test-browser.desktop
    rm -f /tmp/browser-history.txt

execute: |
    #shellcheck source=tests/lib/pkgdb.sh
    . "$TESTSLIB"/desktop-portal.sh

    echo "Install the portals test client"
    snap install --edge test-snapd-portal-client

    echo "The confined application can open URLs in the default browser"
    as_user test-snapd-portal-client open-uri http://www.example.org

    echo "The test-browser process was invoked with the URL"
    [ -f /tmp/browser-history.txt ]
    MATCH http://www.example.org < /tmp/browser-history.txt
