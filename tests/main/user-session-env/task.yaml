summary: verify that user environment settings are added

description: |
    User environment variables are added via /etc/profile.d/snapd.sh (bash/sh
    specific) or via /lib/environment.d/ helpers. Make sure that at least one of
    the mechanisms works and XDG_DATA_DIRS and PATH are updated accordingly
    inside the user session, no matter the shell they use.

# environment generators were introduced in systemd 233, anything before that
# will not work
systems:
   # cannot install zsh
   - -ubuntu-core-*

environment:
    TEST_ZSH_USER: test-zsh
    NO_USER_SESSION_SYSTEMS: ubuntu-14.04 amazon-linux centos-7 debian-9 ubuntu-16.04

prepare: |
    echo "create a user with a different shell"
    useradd --create-home --user-group -s /bin/zsh "$TEST_ZSH_USER"

    for sys in $NO_USER_SESSION_SYSTEMS; do
        if echo "$SPREAD_SYSTEM" | grep "${sys}-"; then
            exit 0
        fi
    done

    touch ./has-sessions

    # setup for systems supporting user sessions
    for uid in $(id -u test) $(id -u "$TEST_ZSH_USER"); do
        mkdir -p "/run/user/$uid"
        chown -R "$uid:$uid" "/run/user/$uid"
        systemctl start "user@$uid.service"
    done

restore: |
    userdel -f -r "$TEST_ZSH_USER"

    rm -f test-profile-env test-profile-zsh-env test-session-env test-zsh-session-env

    if [[ -e has-sessions ]]; then
        for uid in $(uid -u test) $(uid -u "$TEST_ZSH_USER"); do
            systemctl stop "user@$uid.service"
        done
    fi
    rm -f ./has-sessions

execute: |
    #shellcheck source=tests/lib/dirs.sh
    . "$TESTSLIB/dirs.sh"

    for user in test "$TEST_ZSH_USER"; do
        if [[ -e ./has-sessions ]]; then
            uid=$(id -u "$user")
            # dump the environment set up by the user session manager
            su -l "$user" -c "XDG_RUNTIME_DIR=/run/user/$uid systemctl --user show-environment" > "${user}-session-env"
        fi
        su -l "$user" -c "env" > "${user}-profile-env"
    done

    for user in test "$TEST_ZSH_USER"; do
        if [[ -e ./has-sessions ]]; then
            MATCH 'XDG_DATA_DIRS=.*[:]?/var/lib/snapd/desktop[:]?.*' < "${user}-session-env"
            MATCH "PATH=.*[:]?${SNAP_MOUNT_DIR}/bin[:]?.*" < "${user}-session-env"
        fi
        # profile should also be correctly set up
        case "$user:$SPREAD_SYSTEM" in
            test-zsh:ubuntu-*|test-zsh:debian-*)
                # due to https://bugs.launchpad.net/ubuntu/+source/zsh/+bug/1640514
                not MATCH 'XDG_DATA_DIRS=.*[:]?/var/lib/snapd/desktop[:]?.*' < "${user}-profile-env"
                not MATCH "PATH=.*[:]?${SNAP_MOUNT_DIR}/bin[:]?.*" < "${user}-profile-env"
                ;;
            *)
                MATCH 'XDG_DATA_DIRS=.*[:]?/var/lib/snapd/desktop[:]?.*' < "${user}-profile-env"
                MATCH "PATH=.*[:]?${SNAP_MOUNT_DIR}/bin[:]?.*" < "${user}-profile-env"
                ;;
        esac
    done
