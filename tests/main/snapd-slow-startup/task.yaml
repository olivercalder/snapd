summary: Test that snapd is not terminated by systemd on a slow startup

systems: [ubuntu-16.04-64, ubuntu-18.04-64]

restore: |
    # extra cleanup in case something in this test went wrong
    rm -f /etc/systemd/system/snapd.service.d/slow-startup.conf
    systemctl stop snapd.service snapd.socket

debug: |
    ls /etc/systemd/system/snapd.service.d
    cat /etc/systemd/system/snapd.service.d/*

execute: |
    # have 6 extra snaps installed, makes 7 with core
    snap pack "$TESTSLIB"/snaps/basic
    snap set system experimental.parallel-instances=true
    for i in $(seq 6); do
        snap install --dangerous --name="basic_$i" basic_1.0_all.snap
    done

    # shellcheck source=tests/lib/journalctl.sh
    . "$TESTSLIB/journalctl.sh"

    echo "Simulate a slow startup"
    systemctl stop snapd.service snapd.socket
    cat > /etc/systemd/system/snapd.service.d/slow-startup.conf <<EOF
    [Service]
    Environment=SNAPD_SLOW_STARTUP=55s
    Restart=no
    TimeoutStartSec=50s
    EOF
    systemctl daemon-reload

    # startup timeout will be adjusted by 30s + 7 * 5s and this will succeed
    systemctl start snapd.service snapd.socket

    check_journalctl_log "adjusting startup timeout by 1m5s"
