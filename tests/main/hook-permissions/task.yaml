summary: Ensure that post-refresh hook has permissions for its connected slot.

# Note: it is critical for this test to use a slot that requires
# peer=<plug security tag> expression label for dbus, and not simply
# label=unconfined on a permanent slot snippet.
details: |
    Ensure that post-refresh hook has permissions to query upower-observe slot
    and enumerate upower devices.

systems: [-fedora-*, -opensuse-*, -arch-*, -amazon-*, -centos-*]

restore: |
    rm -f ./enumerate.txt
    snap remove --purge test-snap || true
    . "$TESTSLIB/systems.sh"
    if is_core_system; then
      snap remove --purge upower || true
    fi

prepare: |
    # shellcheck source=tests/lib/systems.sh
    . "$TESTSLIB/systems.sh"
    if is_core_system; then
        snap install upower
    fi
    snap pack test-snap
    snap install --dangerous test-snap_1.0_all.snap

execute: |
    # trigger upowerd to have the service started as AppArmor would deny to
    # start it in response to a dbus call from inside a snap (because the
    # service is not started yet and AppArmor doesn't know what confinement
    # the service would be started under, so it denies the startup).
    # The dbus-send output starts with a variable header, tail filters it out.
    dbus-send --print-reply --system --dest=org.freedesktop.UPower /org/freedesktop/UPower org.freedesktop.UPower.EnumerateDevices | tail --lines="+2" > enumerate.txt

    # simulate refresh; the post-refresh hook does same dbus query
    snap install --dangerous test-snap_1.0_all.snap

    # we should have same enumeration result
    diff -w /var/snap/test-snap/common/enumerate.txt ./enumerate.txt
