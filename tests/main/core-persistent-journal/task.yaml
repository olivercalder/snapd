summary: Test journal.persistent core config option

systems: [ubuntu-core-*]

execute: |
    echo "Sanity check, persistent journal is not available by default"
    not test -e /var/log/journal

    echo "Check that persistent journal can be enabled"
    snap set core journal.persistent=true
    test -e /var/log/journal/
    stat -c "%G" /var/log/journal | MATCH "systemd-journal"

    MACHINE_ID=$(cat /etc/machine-id)
    retry-tool -n30 --wait 1 test -e "/var/log/journal/$MACHINE_ID"

    echo "Check that persistent journal can be disabled"
    snap set core journal.persistent=false
    not test -e /var/log/journal