summary: Automatic connection gets dropped on refresh

details: |
      Automatic connection gets removed and not reported by connections if respective plug
      is no longer present in the refreshed snap.

prepare: |
  snap pack test-snap-v1
  snap pack test-snap-v2

execute: |
  echo "Checking that 'home' connection is not reported after removing the test snap"

  snap install --dangerous simplesnap_1.0_all.snap
  snap connections simplesnap | MATCH "home *simplesnap:home *:home *- *"
  snap remove simplesnap
    if snap connections simplesnap | MATCH "home"; then
    echo "Expected simplesnap:home to be gone after snap got removed"
    exit 1
  fi

  echo "Checking that 'home' connection is not reported after refresh to a revision that doesn't have home plug"

  snap install --dangerous simplesnap_1.0_all.snap
  snap connections simplesnap | MATCH "home *simplesnap:home *:home *- *"
  snap install --dangerous simplesnap_2.0_all.snap
  if snap connections simplesnap | MATCH "home"; then
    echo "Expected simplesnap:home to be gone"
    exit 1
  fi

