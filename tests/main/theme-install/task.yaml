summary: Verify that the theme REST API endpoints function correctly

prepare: |
    snap install --edge jq

execute: |
    "$TESTSTOOLS"/snaps-state install-local api-client
    echo "The snapd*-control plugs on the api-client snap are initially disconnected"
    snap connections api-client | MATCH "snapd-control +api-client:snapd-control +- +-"
    snap connections api-client | MATCH "snapd-themes-control +api-client:snapd-themes-control +- +-"
    echo "Connect the snapd-control plug"
    snap connect api-client:snapd-control

    echo "Install the gtk-common-themes snap"
    snap install gtk-common-themes

    echo "Check for presence of a collection of themes"
    api-client '/v2/accessories/themes?gtk-theme=Yaru&gtk-theme=TraditionalHumanized&icon-theme=Yaru&icon-theme=Adwaita&sound-theme=Yaru&sound-theme=No-Such-Theme' > response.txt
    jq . < response.txt

    jq -r '.result."gtk-themes".Yaru' < response.txt | MATCH '^installed'
    jq -r '.result."gtk-themes".TraditionalHumanized' < response.txt | MATCH '^available'
    jq -r '.result."icon-themes".Yaru' < response.txt | MATCH '^installed'
    jq -r '.result."icon-themes".Adwaita' < response.txt | MATCH '^installed'
    jq -r '.result."sound-themes".Yaru' < response.txt | MATCH '^installed'
    jq -r '.result."sound-themes"."No-Such-Theme"' < response.txt | MATCH '^unavailable'

    echo "We can request installation of a snap to satisfy a theme"
    api-client --method=POST /v2/accessories/themes '{"gtk-themes":["TraditionalHumanized"]}' > response.txt
    jq . < response.txt

    echo "Wait for change to complete"
    change_id="$(jq -r .change < response.txt)"
    snap watch "$change_id"

    echo "The snap providing the theme is now installed"
    snap list | grep gtk-theme-traditionalhumanized

    echo "The theme now reports as installed"
    api-client '/v2/accessories/themes?gtk-theme=TraditionalHumanized' > response.txt
    jq -r '.result."gtk-themes".TraditionalHumanized' < response.txt | MATCH '^installed'
