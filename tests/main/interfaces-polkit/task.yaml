summary: Ensure that the polkit interface works.

systems: [-ubuntu-core-*]

execute: |
    echo "Install the test snap"
    "$TESTSTOOLS"/snaps-state install-local test-snapd-pk-service

    echo "The polkit interface is disconnected by default"
    snap connections test-snapd-pk-service | MATCH "polkit +test-snapd-pk-service:polkit +- +-"

    echo "The polkit policy file is not installed"
    test ! -f /usr/share/polkit-1/actions/snap.test-snapd-pk-service.interface.polkit.policy
    
    echo "The interface can be connected"
    snap connect test-snapd-pk-service:polkit
    snap connections test-snapd-pk-service | MATCH "polkit +test-snapd-pk-service:polkit +:polkit +manual"

    echo "Snapd has installed the policy file for the service"
    test -f /usr/share/polkit-1/actions/snap.test-snapd-pk-service.interface.polkit.policy
    echo "The contents match the file provided by the snap"
    cmp /usr/share/polkit-1/actions/snap.test-snapd-pk-service.interface.polkit.policy ./test-snapd-pk-service/meta/polkit.policy

    this_pid=$$
    echo "The snap can talk to polkitd"
    test-snapd-pk-service.check-pid $this_pid org.example.foo.AlwaysAllow \
      | MATCH '^\(bba\{ss\}\) true false '
    test-snapd-pk-service.check-pid $this_pid org.example.foo.AlwaysDeny \
      | MATCH '^\(bba\{ss\}\) false false '
