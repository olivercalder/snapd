summary: Check that "snap connections" works as expected

execute: |
    # shellcheck source=tests/lib/snaps.sh
    . "$TESTSLIB/snaps.sh"

    snap connections > all.out 2>&1
    test "$(wc -l < all.out)" = "0"

    snap install test-snapd-content-slot
    expected='- +test-snapd-content-slot:shared-content-slot +content +-'
    # asking for a snap shows connected and unconnected plugs and slots
    snap connections test-snapd-content-slot | MATCH -- "$expected"

    snap connections test-snapd-content-slot --all 2>&1 | MATCH 'error: cannot use --all with snap name'

    # test-snapd-content-slot is the only snap installed and it has no connections yet
    snap connections > all.out 2>&1
    test "$(wc -l < all.out)" = "0"
    # but it will show up if we ask for all or disconnected plugs and slots
    snap connections --all | MATCH -- "$expected"

    snap install test-snapd-content-plug
    expected='test-snapd-content-plug:shared-content-plug +test-snapd-content-slot:shared-content-slot +content +-'
    snap connections test-snapd-content-plug | MATCH "$expected"
    snap connections test-snapd-content-slot | MATCH "$expected"

    # :network is connected by default
    install_local network-consumer
    expected='network-consumer:network +:network +network +-'
    snap connections network-consumer | MATCH "$expected"
    # disconect it manually
    snap disconnect network-consumer:network
    expected='network-consumer:network +- +network +-'
    snap connections network-consumer 2>&1 | MATCH "$expected"

    # try with an interface which is not connected by default
    install_local test-snapd-daemon-notify
    expected='test-snapd-daemon-notify:daemon-notify +- +daemon-notify +-'
    snap connections test-snapd-daemon-notify | MATCH "$expected"

    snap connect test-snapd-daemon-notify:daemon-notify
    # once connected, the connection will show up as manual
    expected='test-snapd-daemon-notify:daemon-notify +:daemon-notify +daemon-notify +manual'
    snap connections test-snapd-daemon-notify | MATCH "$expected"

    expected='test-snapd-daemon-notify:daemon-notify +- +daemon-notify +-'
    snap disconnect test-snapd-daemon-notify:daemon-notify
    snap connections test-snapd-daemon-notify | MATCH "$expected"

    # show connected only
    snap connections > connected.out
    MATCH 'test-snapd-content-plug:shared-content-plug +test-snapd-content-slot:shared-content-slot +content +-' < connected.out
    MATCH -v 'network-consumer' < connected.out
    MATCH -v 'test-snapd-daemon-notify' < connected.out

    # show all
    snap connections --all > all.out
    MATCH 'test-snapd-content-plug:shared-content-plug +test-snapd-content-slot:shared-content-slot +content +-' < all.out
    MATCH 'test-snapd-daemon-notify:daemon-notify +- +daemon-notify +-' < all.out
    MATCH 'network-consumer:network +- +network +-' < all.out
