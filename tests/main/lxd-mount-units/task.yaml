summary: Test mount units generated for snaps inside lxd container are correct.

details: |
    Test that mount units generated by snapd-generator inside lxd container
    are correct for snapfuse.

# only 20.10+, we want lxd images that come with snaps preinstalled.
systems: [ubuntu-20.10*]

execute: |
    echo "Install lxd"
    snap install lxd

    lxd waitready
    lxd init --auto

    VERSION_ID="$(. /etc/os-release && echo "$VERSION_ID" )"
    lxd.lxc launch --quiet "ubuntu:$VERSION_ID" ubuntu

    lxd.lxc file push --quiet "$GOHOME"/snapd_*.deb "ubuntu/root/"

    DEB=$(basename "$GOHOME"/snapd_*.deb)
    lxd.lxc exec ubuntu -- apt install -y /root/"$DEB"
    lxd.lxc restart ubuntu

    echo "Sanity check that mount overrides were generated inside the container"
    lxd.lxc exec ubuntu -- find /var/run/systemd/generator/ -name container.conf | MATCH "/var/run/systemd/generator/snap-core18.*mount.d/container.conf"
    lxd.lxc exec ubuntu -- test -f /var/run/systemd/generator/snap.mount

    echo "Sanity check that core18 snap is mounted correctly"
    # Make sure core18 is mounted and readable for a regular user
    retry -n 5 --wait 1 sh -c 'lxd.lxc exec ubuntu -- sudo --user ubuntu --login ls /snap/core18/current'
    retry -n 5 --wait 1 sh -c 'lxd.lxc exec ubuntu -- sudo --user ubuntu --login mount | grep core18| grep allow_other'

restore: |
    lxd.lxc stop ubuntu --force || true
    lxd.lxc delete ubuntu || true
    snap remove --purge lxd
