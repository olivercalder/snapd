summary: Ensure that the content slots for classic snaps works.

details: |
    The content-sharing interface interface allows a snap to access contents from
    other snap. It is possible to have content slots in classic snaps, where
    confined snaps can connect to.

    A snap which defines the content sharing plug must be shown in the interfaces list.
    The plug must be autoconnected on install and, as usual, must be able to be
    reconnected.

# slow in autopkgtest (>4m)
backends: [-autopkgtest]

# We use classic snaps for the test, so it cannot run on core
systems: [-ubuntu-core-*]

prepare: |
    echo "Ensure an empty state so that installing test-snapd-content-plug-to-classic-slot"
    echo "will pull in test-snapd-classic-content-slot *and* core"

    #shellcheck source=tests/lib/systemd.sh
    . "$TESTSLIB/systemd.sh"

    systemd_stop_units snapd.service
    rm -f /var/lib/snapd/state.json
    systemctl start snapd
    snap wait system seed.loaded

execute: |
    echo "When a snap declaring a content sharing plug is installed"
    snap install --edge test-snapd-content-plug-to-classic-slot

    echo "Then this pulls in the default provider, classic in this case"
    snap list | MATCH test-snapd-classic-content-slot

    echo "Then the snap is listed as connected"
    snap interfaces -i content |
        grep -Pzq "test-snapd-classic-content-slot:shared-content-slot +test-snapd-content-plug-to-classic-slot:shared-content-plug"

    echo "And fstab files are created"
    [ "$(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l)" -gt 0 ]

    echo "And we can use the shared content"
    test-snapd-content-plug-to-classic-slot.content-plug | grep "Some shared content"

    echo "And the current mount profile is the same as the desired mount profile"
    diff -u /run/snapd/ns/snap.test-snapd-content-plug-to-classic-slot.fstab /var/lib/snapd/mount/snap.test-snapd-content-plug-to-classic-slot.fstab

    echo "When the plug is disconnected"
    snap disconnect test-snapd-content-plug-to-classic-slot:shared-content-plug test-snapd-classic-content-slot:shared-content-slot

    echo "Then the fstab files are removed"
    [ "$(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l)" -eq 0 ]

    echo "When the plug is reconnected"
    snap connect test-snapd-content-plug-to-classic-slot:shared-content-plug test-snapd-classic-content-slot:shared-content-slot

    echo "Then the fstab files are recreated"
    [ "$(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l)" -gt 0 ]
