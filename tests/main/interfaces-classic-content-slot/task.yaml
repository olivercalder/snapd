summary: Ensure that the content slots for classic snaps works.

details: |
    The content-sharing interface interface allows a snap to access contents from
    other snap. It is possible to have content slots in classic snaps, where
    confined snaps can connect to.

    A snap which defines the content sharing plug must be shown in the interfaces list.
    The plug must be autoconnected on install and, as usual, must be able to be
    reconnected.

# We use classic snaps for the test, so it cannot run on core
systems: [-ubuntu-core-*]

environment:
    PROVIDER_SNAP: test-snapd-classic-content-slot
    CONSUMER_SNAP: test-snapd-content-plug-to-classic-slot

execute: |
    echo "Install content plug, check that the classic provider is not pulled"
    snap install --edge "$CONSUMER_SNAP"

    echo "Install classic snap with content slot - no automatic pull for classic"
    snap install --edge --classic "$PROVIDER_SNAP"

    echo "Then the snap is listed as connected"
    snap connections "$PROVIDER_SNAP" |
        MATCH "$CONSUMER_SNAP:shared-content-plug \+$PROVIDER_SNAP:shared-content-slot"

    echo "Remove snaps, install in reverse order"
    snap remove --purge "$CONSUMER_SNAP"
    snap remove --purge "$PROVIDER_SNAP"
    snap install --edge --classic "$PROVIDER_SNAP"
    snap install --edge "$CONSUMER_SNAP"

    echo "Check that the content interface has been auto-connected"
    snap connections "$PROVIDER_SNAP" |
        MATCH "$CONSUMER_SNAP:shared-content-plug \+$PROVIDER_SNAP:shared-content-slot"

    echo "And fstab files are created"
    [ "$(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l)" -gt 0 ]

    echo "And we can use the shared content"
    "$CONSUMER_SNAP".content-plug | MATCH "Some shared content"

    echo "And the current mount profile is the same as the desired mount profile"
    diff -u /run/snapd/ns/snap."$CONSUMER_SNAP".fstab /var/lib/snapd/mount/snap."$CONSUMER_SNAP".fstab

    echo "When the plug is disconnected"
    snap disconnect "$CONSUMER_SNAP":shared-content-plug "$PROVIDER_SNAP":shared-content-slot

    echo "Then the fstab files are removed"
    [ "$(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l)" -eq 0 ]

    echo "When the plug is reconnected"
    snap connect "$CONSUMER_SNAP":shared-content-plug "$PROVIDER_SNAP":shared-content-slot

    echo "Then the fstab files are recreated"
    [ "$(find /var/lib/snapd/mount -type f -name "*.fstab" | wc -l)" -gt 0 ]
