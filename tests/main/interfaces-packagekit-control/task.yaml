summary: The packagekit-control interface grants access to PackageKit

systems: [-ubuntu-core-*]

execute: |
    echo "Installing test-snapd-packagekit"
    snap install --edge test-snapd-packagekit

    echo "The packagekit-control plug is disconnected by default"
    snap connections test-snapd-packagekit | MATCH "packagekit-control +test-snapd-packagekit:packagekit-control +- +-"
    if [ "$(snap debuf confinement)" = strict ]; then
        echo "Access to PackageKit is blocked without"
        test-snapd-packagekit.pkcon backend-details | MATCH "Failed to contact PackageKit"
    fi

    echo "The plug can be connected"
    snap connect test-snapd-packagekit:packagekit-control
    snap connections test-snapd-packagekit | MATCH "packagekit-control +test-snapd-packagekit:packagekit-control +:packagekit-control +manual"

    echo "With the plug connected it is possible to communicate with packagekit"
    test-snapd-packagekit.pkcon backend-details | MATCH "Name:"
    test-snapd-packagekit.pkcon required-by snapd
