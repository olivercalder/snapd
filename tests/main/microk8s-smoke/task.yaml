summary: Smoke test for microk8s

environment:
    CHANNEL/edge: latest/edge/strict

prepare: |
    cp /etc/systemd/system/snapd.service.d/local.conf /etc/systemd/system/snapd.service.d/local.conf.bak
    sed 's/SNAPD_CONFIGURE_HOOK_TIMEOUT=.*s/SNAPD_CONFIGURE_HOOK_TIMEOUT=180s/g' -i /etc/systemd/system/snapd.service.d/local.conf
    systemctl daemon-reload
    systemctl restart snapd.socket

restore: |
    mv /etc/systemd/system/snapd.service.d/local.conf.bak /etc/systemd/system/snapd.service.d/local.conf
    systemctl daemon-reload
    systemctl restart snapd.socket

execute: |
    snap install --channel="$CHANNEL" microk8s
    microk8s status --wait-ready
    # XXX: enable dashboard etc? doing this is slow :/
    #microk8s enable dashboard dns registry istio
    microk8s kubectl get nodes | MATCH Ready
    microk8s kubectl get services | MATCH kubernetes
    
    microk8s kubectl create deployment nginx --image=nginx
    retry -n 20 sh -c "microk8s kubectl get pods | MATCH Running"
    # XXX: test if ngix can be connected

    
    
