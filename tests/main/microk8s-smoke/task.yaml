summary: Smoke test for microk8s

environment:
    CHANNEL/edge: latest/edge/strict

prepare: |
    # The default timeout for the configure hook is 5min - however in the
    # testsuite this is lowered. We need to undo this for the microk8s spread
    # test because it really take a bit to get configured.
    cp /etc/systemd/system/snapd.service.d/local.conf /etc/systemd/system/snapd.service.d/local.conf.bak
    sed 's/SNAPD_CONFIGURE_HOOK_TIMEOUT=.*s/SNAPD_CONFIGURE_HOOK_TIMEOUT=180s/g' -i /etc/systemd/system/snapd.service.d/local.conf
    systemctl daemon-reload
    systemctl restart snapd.socket

restore: |
    mv /etc/systemd/system/snapd.service.d/local.conf.bak /etc/systemd/system/snapd.service.d/local.conf
    systemctl daemon-reload
    systemctl restart snapd.socket

    snap remove --purge microk8s

    # TODO: remove handling of snap_daemon user once microk8s is updated not
    # to use it
    for user in snap_microk8s snap_daemon
    do
        userdel -f "$user" || userdel -f --extrausers "$user" || true
        groupdel "$user" || groupdel --extrausers "$user" || true
    done

execute: |
    snap install --channel="$CHANNEL" microk8s
    microk8s status --wait-ready
    # XXX: enable dashboard etc? doing this is slow :/
    #microk8s enable dashboard dns registry istio
    microk8s kubectl get nodes | MATCH Ready
    microk8s kubectl get services | MATCH kubernetes
    
    microk8s kubectl create deployment nginx --image=nginx
    retry -n 40 sh -c "microk8s kubectl get pods | MATCH Running"
    # XXX: test if ngix can be connected
