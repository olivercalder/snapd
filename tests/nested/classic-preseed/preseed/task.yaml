summary: Check that preseeded ubuntu cloud image boots.

description: |
  This test checks that preseeding of Ubuntu cloud images with snap-preseed
  command works, and the resulting image boots and finalizes seeding.
  The test assumes cloud image with a core and lxd snaps in its seeds/.

systems: [ubuntu-19.10-*,ubuntu-20.04-*]

environment:
  IMAGE_MOUNTPOINT: /mnt/cloudimg

prepare: |
  apt install -y qemu-utils kpartx
  mkdir -p "$IMAGE_MOUNTPOINT"

  #shellcheck source=tests/lib/nested.sh
  . "$TESTSLIB/nested.sh"

  CLOUD_IMAGE=$(get_nested_classic_image_path)

  #shellcheck source=tests/lib/preseed.sh
  . "$TESTSLIB/preseed.sh"

  mount_ubuntu_image "$CLOUD_IMAGE" "$IMAGE_MOUNTPOINT"
  setup_preseeding "$IMAGE_MOUNTPOINT"

restore: |
  # any of the restore commands can fail depending on where execute part stopped,
  # account for that with ||true.
  umount_ubuntu_image "$IMAGE_MOUNTPOINT" || true

execute: |
  echo "Running pre-seeeding"
  /usr/lib/snapd/snap-preseed "$IMAGE_MOUNTPOINT"

  # mark-preseeded task is where snap-preseed stopped, therefore it's in Doing.
  snap debug state "$IMAGE_MOUNTPOINT"/var/lib/snapd/state.json --change=1 | MATCH "Doing .+ mark-preseeded +Mark system pre-seeded"
  snap debug state "$IMAGE_MOUNTPOINT"/var/lib/snapd/state.json | MATCH "Doing .+ Initialize system state"

  cp "$IMAGE_MOUNTPOINT/var/lib/snapd/system-key" system-key.preseeded

  #shellcheck source=tests/lib/preseed.sh
  . "$TESTSLIB/preseed.sh"
  umount_ubuntu_image "$IMAGE_MOUNTPOINT"

  #shellcheck source=tests/lib/nested.sh
  . "$TESTSLIB/nested.sh"
  start_nested_classic_vm

  echo "Waiting for firstboot seeding to finish"
  execute_remote "sudo snap wait system seed.loaded"
  execute_remote "snap changes" | MATCH "Done .+ Initialize system state"

  execute_remote "cat /var/lib/snapd/system-key" > system-key.real
  # XXX: this currently fails because we're running it on 18.04 gc system and
  # kernel aa features differ one the booted 19.10/20.04 image;
  # uncomment this once proper systems are in place.
  #diff -u -w system-key.real system-key.preseeded

  echo "Checking that lxd snap is operational"
  execute_remote "snap list" | not MATCH "broken"
  execute_remote "snap services" | MATCH "lxd.activate +enabled +inactive"
  execute_remote "snap services" | MATCH "lxd.daemon +enabled +inactive +socket-activated"
  execute_remote "sudo lxd init --auto"
  execute_remote "snap services" | MATCH "+lxd.daemon +enabled +active +socket-activated"


