summary: Test that config defaults are applied early when image is created.

prepare: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    mkdir extra-snaps

    snap download --channel=18/stable pc
    GADGET_SNAP=$(ls pc_*.snap)
    unsquashfs -no-progress "$GADGET_SNAP"
    rm -f "$GADGET_SNAP"

    cat defaults.yaml >> squashfs-root/meta/gadget.yaml
    cat plugs.yaml >> squashfs-root/meta/snap.yaml

    mkdir -p squashfs-root/meta/hooks
    cp install squashfs-root/meta/hooks/
    mksquashfs squashfs-root "$GADGET_SNAP" -comp xz -no-fragments -no-progress
    rm -rf squashfs-root
    mv "$GADGET_SNAP" extra-snaps/

    create_nested_core_vm false
    start_nested_core_vm

kill-timeout: 40m

restore: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    destroy_nested_vm
    cleanup_nested_env
    rm -rf extra-snaps

debug: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

execute: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    execute_remote "sudo snap wait system seed.loaded"

    echo "Test that rsyslog was disabled early"
    execute_remote "cat /var/snap/pc/common/debug.txt" | MATCH "/dev/null"
    