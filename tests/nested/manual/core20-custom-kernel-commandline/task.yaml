summary: Verify custom kernel command line handling in UC20

systems: [ubuntu-20.04-64]

environment:
    NESTED_BUILD_SNAPD_FROM_CURRENT: true

details: |
    This test checks support for customized kernel command line arguments in UC20

debug: |
    cat system.cmdline.run || true
    cat system.cmdline.recover || true

prepare: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    KEY_NAME=$(nested_get_snakeoil_key)
    SNAKEOIL_KEY="$PWD/$KEY_NAME.key"
    SNAKEOIL_CERT="$PWD/$KEY_NAME.pem"

    echo "Grab and prepare the gadget snap"
    snap download --basename=pc --channel="20/edge" pc
    unsquashfs -d pc-gadget pc.snap

    echo "Sign the shim binary"
    nested_secboot_sign_gadget pc-gadget "$SNAKEOIL_KEY" "$SNAKEOIL_CERT"

    echo 'hello from test' > pc-gadget/cmdline.extra
    snap pack pc-gadget/ extra-snaps/

    "$TESTSTOOLS"/nested-state build-image core
    "$TESTSTOOLS"/nested-state create-vm core

execute: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    # system is in run mode
    nested_exec 'sudo cat /proc/cmdline' > system.cmdline.run
    MATCH snapd_recovery_mode=run < system.cmdline.run

    echo "Verify kernel command line in run mode"
    MATCH 'snapd_recovery_mode=run .* hello from test$' < system.cmdline.run

    echo "Transition to recover mode to verify kernel command line"
    boot_id="$(nested_get_boot_id)"
    # shellcheck disable=SC2016
    nested_exec 'sudo snap reboot --recover'
    nested_wait_for_reboot "${boot_id}"

    echo "Check the vm is in recover mode"
    nested_exec 'sudo cat /proc/cmdline' > system.cmdline.recover
    MATCH snapd_recovery_mode=recover < system.cmdline.recover

    MATCH 'snapd_recovery_mode=recover snapd_recovery_system=.* .* hello from test$' < system.cmdline.recover
