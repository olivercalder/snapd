summary: Run a smoke test on UC20 with encryption enabled

description: |
  This test checks if UC20 passes the smoke test suite with secure boot

systems: [ubuntu-20.04-*]

kill-timeout: 40m

environment:
   SPREAD_DIR: $PWD/spread-dir
   SPREAD_EXTERNAL_ADDRESS: 127.0.0.1:8022

prepare: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    create_nested_core_vm true
    start_nested_core_vm

    mkdir -p "$SPREAD_DIR"

restore: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    destroy_nested_vm
    cleanup_nested_env

    rm -rf "$SPREAD_DIR"

execute: |

    ( cd "$SPREAD_DIR" && curl -s -O https://niemeyer.s3.amazonaws.com/spread-amd64.tar.gz && tar xzvf spread-amd64.tar.gz )

    sshpass -p ubuntu ssh -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 8022 user1@127.0.0.1 "sudo adduser --extrausers --quiet --disabled-password --gecos '' test" || true
    sshpass -p ubuntu ssh -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 8022 user1@127.0.0.1 "echo test:ubuntu | sudo chpasswd"
    sshpass -p ubuntu ssh -q -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -p 8022 user1@127.0.0.1 "echo 'test ALL=(ALL) NOPASSWD:ALL' | sudo tee /etc/sudoers.d/create-user-test"

    cd "$PROJECT_PATH"
    "$SPREAD_DIR/spread" external:ubuntu-core-20-64:tests/smoke/
