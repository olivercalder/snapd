summary: Run a smoke test on UC20 with encryption enabled

description: |
    This test checks if UC20 passes the smoke test suite with secure boot

systems: [ubuntu-20.04-*]

kill-timeout: 30m

environment:
   SPREAD_DIR: $PWD/spread-dir
   SPREAD_EXTERNAL_ADDRESS: 127.0.0.1:8022

prepare: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    create_nested_core_vm true
    start_nested_core_vm

    mkdir -p "$SPREAD_DIR"

restore: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    destroy_nested_vm
    cleanup_nested_env

    rm -rf "$SPREAD_DIR"

execute: |

    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    echo "Ensure 'snap install' works"
    # The install command could cause a ssh break, so || true is used
    # and then we check the installation was completed successfully
    execute_remote "sudo snap install test-snapd-sh" || true

    echo "Ensure 'snap list' works"
    execute_remote "snap list" | MATCH test-snapd-sh

    echo "Ensure 'snap find' works"
    execute_remote "snap find test-snapd-sh" | MATCH ^test-snapd-sh

    echo "Ensure 'snap info' works"
    execute_remote "snap info test-snapd-sh" | MATCH '^name:\ +test-snapd-sh'

    echo "Ensure 'snap remove' works"
    # The install command could cause a ssh break, so || true is used
    # and then we check the removal was completed successfully
    execute_remote "sudo snap remove test-snapd-sh" || true

    echo "Ensure 'snap list' works"
    execute_remote "snap list" | NOMATCH test-snapd-sh
