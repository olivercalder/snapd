summary: Check that tpm works properly on UC20

description: |
  This test check UC20 can boot with secure boot sucessfully and UC18 doesn't boot with secure boot

systems: [ubuntu-18.04-*, ubuntu-20.04-*]

prepare: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    create_nested_core_vm true
    start_nested_core_vm 

restore: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    destroy_nested_vm
    cleanup_nested_env

execute: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    # Check tpm status on the nested vm   
    if is_core_20_nested_system; then
        execute_remote "mokutil --sb-state" | MATCH "SecureBoot enabled"
    else        
        execute_remote "dmesg | grep -i tpm" | MATCH "No TPM chip found"
    fi

    # Check the nested image runs the current branch  
    execute_remote "systemctl is-active snapd.spread-tests-run-mode-tweaks" | MATCH "active"
