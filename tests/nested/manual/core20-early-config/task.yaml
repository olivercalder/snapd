summary: Test that config defaults are applied early.

systems: [ubuntu-20.04-64]

prepare: |
    ENABLE_TPM="true"
    ENABLE_SECURE_BOOT="true"
    BUILD_SNAPD_FROM_CURRENT="true"
    
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    cleanup_nested_env

    mkdir extra-snaps

    # Get the snakeoil key and cert
    KEY_NAME=$(get_snakeoil_key)
    SNAKEOIL_KEY="$PWD/$KEY_NAME.key"
    SNAKEOIL_CERT="$PWD/$KEY_NAME.pem"

    # modify and repack gadget snap (add defaults section and install hook)aÄ…
    snap download --basename=pc --channel="20/edge" pc
    unsquashfs -d pc-gadget pc.snap

    cat defaults.yaml >> pc-gadget/meta/gadget.yaml
    mkdir -p pc-gadget/meta/hooks
    cp install pc-gadget/meta/hooks/

    sbattach --remove pc-gadget/shim.efi.signed
    sbsign --key "$SNAKEOIL_KEY" --cert "$SNAKEOIL_CERT" --output pc-gadget/shim.efi.signed pc-gadget/shim.efi.signed
    snap pack pc-gadget/ extra-snaps/

    rm -f "$SNAKEOIL_KEY" "$SNAKEOIL_CERT"

    create_nested_core_vm

    # Modify seed options to use devmode for pc gadget snap. This is needed for the
    # install hook to have access to /etc/systemd. Ideally we would use
    # system-files plug, but it wouldn't get autoconnected due to assertions. 
    IMAGE_PATH="$(get_nested_core_image_path)"
    loops=$(kpartx -avs "$IMAGE_PATH"  | cut -d' ' -f 3)
    part=$(echo "$loops" | tail -1)
    tmp=$(mktemp -d)
    mount "/dev/mapper/$part" "$tmp"
    OPTIONS_PATH=$(find "$tmp/systems" -name options.yaml)
    sed -i "$OPTIONS_PATH" -E -e 's/^(\s+)unasserted: (pc_.+)/\1unasserted: \2\n\1devmode: true/'
    umount "$tmp"
    kpartx -d "$IMAGE_PATH"
    rmdir "$tmp"

    start_nested_core_vm

restore: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    destroy_nested_vm
    cleanup_nested_env

execute: |
    #shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    execute_remote "sudo snap wait system seed.loaded"

    echo "Test that rsyslog was disabled early."
    # early config is witnessed by install hook of the pc gadget
    execute_remote "cat /var/snap/pc/common/debug.txt" | MATCH "/dev/null"
    execute_remote "test -L /etc/systemd/system/rsyslog.service"
