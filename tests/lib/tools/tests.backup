#!/bin/sh -e

show_help() {
    echo "usage: tests.backup prepare"
    echo "       tests.backup restore"
}

cmd_prepare() {
    local BACKUP_PATH=${1:-$(pwd)}
    tar cf "${BACKUP_PATH}.tar" "$BACKUP_PATH"
}

cmd_restore() {
    local BACKUP_PATH=${1:-$(pwd)}
    if [ -f "${BACKUP_PATH}.tar" ]; then
        # it is already checked that $BACKUP_PATH is not empty
        # shellcheck disable=SC2115
        rm -rf "${BACKUP_PATH}"/*
        tar -C/ -xf "${BACKUP_PATH}.tar"
        rm "${BACKUP_PATH}.tar"

        # $BACKUP_PATH was cleaned and recreated, enter the directory again
        cd "$BACKUP_PATH"
    else
        echo "tests.backup: cannot restore, backup file does not exist" >&2
        exit 1
    fi
}

if [ $# -eq 0 ]; then
    show_help
    exit
fi

while [ $# -gt 0 ]; do
    case "$1" in
        -h|--help)
            show_help
            exit
            ;;
        prepare)
            shift
            cmd_prepare "$@"
            exit
            ;;
        restore)
            shift
            cmd_restore "$@"
            exit
            ;;
        -*)
            echo "tests.backup: unknown option $1" >&2
            exit 1
            ;;
        *)
            echo "tests.backup: unknown command $1" >&2
            exit 1
            ;;
    esac
done
